#!/usr/bin/env bash

# Set the docker command to use.
DOCKER="docker"

# Disable pseudo-TTY allocation for CI. The -T flag removes interaction.
TTY="-it"

# Travis CI provides a CI environment variable which can be used to check if
# this is running in a CI environment.
if [[ ${CI:-false} == "true" ]]; then
    TTY="-T"
fi

# Pass arguments to docker-compose, or default to docker-compose ps.
if [[ $# -gt 0  ]]; then
    case "$1" in

        store )
            shift 1
            ${DOCKER} run --rm ${TTY} \
                -v `pwd`:/var/www/html \
                -w /var/www/html \
                -e AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-''} \
                -e AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-''} \
                -e AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-''} \
                -e AWS_BUCKET_NAME=${AWS_BUCKET_NAME:-''} \
                ubuntu:latest \
                bash aws/store.sh
            ;;

        deploy )
            shift 1
            ${DOCKER} run --rm ${TTY} \
                -v `pwd`:/var/www/html \
                -w /var/www/html \
                -e ENVIRONMENT=${ENVIRONMENT:-'staging'} \
                -e CI=${CI:-false} \
                node:14 \
                bash .travis/deploy.sh
            ;;

        * )
            shift 1
            ${DOCKER} run --rm ${TTY} \
                -v `pwd`:/var/www/html \
                -w /var/www/html \
                ubuntu:latest \
                "$@"

    esac
fi
